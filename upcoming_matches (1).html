{% extends 'base.html' %}

{% block title %}Upcoming Matches{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Upcoming Matches</h1>
        <hr>
    </div>
</div>

<!-- Calendar View Toggle -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="btn-group" role="group" aria-label="View Toggle">
            <button type="button" class="btn btn-primary active" id="listViewBtn">List View</button>
            <button type="button" class="btn btn-outline-primary" id="calendarViewBtn">Calendar View</button>
        </div>
    </div>
</div>

<!-- List View -->
<div id="listView">
    {% if matches %}
        <div class="row">
            {% for match in matches %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header text-center bg-warning text-dark">
                            <h5 class="mb-0">{{ match[3].strftime('%d %B %Y, %H:%M') }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center text-center">
                                <div class="col-5">
                                    <h5>{{ match[8] }}</h5>
                                    <p class="text-muted">(Home)</p>
                                </div>
                                <div class="col-2">
                                    <h4>vs</h4>
                                </div>
                                <div class="col-5">
                                    <h5>{{ match[9] }}</h5>
                                    <p class="text-muted">(Away)</p>
                                </div>
                            </div>
                            <hr>
                            <p class="text-center"><strong>Venue:</strong> {{ match[10] }}</p>
                            <p class="text-center">
                                <span class="badge 
                                    {% if match[5] == 'Scheduled' %}bg-warning
                                    {% elif match[5] == 'Ongoing' %}bg-info
                                    {% else %}bg-secondary{% endif %}">
                                    {{ match[5] }}
                                </span>
                            </p>
                        </div>
                        <div class="card-footer">
                            <div class="d-grid">
                                <a href="{{ url_for('match.match_details', match_id=match[0]) }}" class="btn btn-outline-primary">View Details</a>
                            </div>
                            {% if session.get('role') == 'fan' %}
                                <div class="d-grid mt-2">
                                    <a href="{{ url_for('ticket_booking', match_id=match[0]) }}" class="btn btn-success">Book Tickets</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">No upcoming matches scheduled.</div>
    {% endif %}
</div>

<!-- Calendar View -->
<div id="calendarView" style="display: none;">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <!-- Month Navigation -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button id="prevMonth" class="btn btn-outline-primary">&laquo; Previous</button>
                        <h3 id="currentMonth" class="mb-0">June 2025</h3>
                        <button id="nextMonth" class="btn btn-outline-primary">Next &raquo;</button>
                    </div>

                    <!-- Calendar -->
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Sun</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                                <th>Sat</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- Calendar cells will be generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Options -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Filter Matches</h4>
            </div>
            <div class="card-body">
                <form id="filterForm" action="{{ url_for('match.upcoming_matches') }}" method="GET">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="team_filter" class="form-label">Team</label>
                            <select class="form-select" id="team_filter" name="team_id">
                                <option value="">All Teams</option>
                                {% for team in teams %}
                                    <option value="{{ team[0] }}">{{ team[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="venue_filter" class="form-label">Venue</label>
                            <select class="form-select" id="venue_filter" name="venue_id">
                                <option value="">All Venues</option>
                                {% for venue in venues %}
                                    <option value="{{ venue[0] }}">{{ venue[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="date_range" class="form-label">Date Range</label>
                            <select class="form-select" id="date_range" name="date_range">
                                <option value="week">Next 7 days</option>
                                <option value="month" selected>Next 30 days</option>
                                <option value="quarter">Next 3 months</option>
                                <option value="all">All upcoming</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // View toggle functionality
    document.getElementById('listViewBtn').addEventListener('click', function() {
        document.getElementById('listView').style.display = 'block';
        document.getElementById('calendarView').style.display = 'none';
        this.classList.add('active');
        this.classList.remove('btn-outline-primary');
        this.classList.add('btn-primary');
        document.getElementById('calendarViewBtn').classList.remove('active');
        document.getElementById('calendarViewBtn').classList.remove('btn-primary');
        document.getElementById('calendarViewBtn').classList.add('btn-outline-primary');
    });
    
    document.getElementById('calendarViewBtn').addEventListener('click', function() {
        document.getElementById('listView').style.display = 'none';
        document.getElementById('calendarView').style.display = 'block';
        this.classList.add('active');
        this.classList.remove('btn-outline-primary');
        this.classList.add('btn-primary');
        document.getElementById('listViewBtn').classList.remove('active');
        document.getElementById('listViewBtn').classList.remove('btn-primary');
        document.getElementById('listViewBtn').classList.add('btn-outline-primary');
        
        // Initialize calendar when switching to calendar view
        initCalendar();
    });
    
    // Calendar functionality
    let currentDate = new Date();
    
    function initCalendar() {
        updateCalendarHeader();
        renderCalendar();
    }
    
    function updateCalendarHeader() {
        const monthNames = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
        document.getElementById('currentMonth').textContent = 
            `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    }
    
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // Get first day of month and last day of month
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        // Calculate days from previous month to show
        const firstDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
        
        // Clear calendar body
        const calendarBody = document.getElementById('calendarBody');
        calendarBody.innerHTML = '';
        
        // Create calendar rows and cells
        let date = 1;
        let nextMonthDate = 1;
        
        // Create match data dictionary by date
        const matchesByDate = {};
        
        {% for match in matches %}
            const matchDate = new Date("{{ match[3] }}");
            const matchDateStr = `${matchDate.getFullYear()}-${matchDate.getMonth()}-${matchDate.getDate()}`;
            
            if (!matchesByDate[matchDateStr]) {
                matchesByDate[matchDateStr] = [];
            }
            
            matchesByDate[matchDateStr].push({
                id: {{ match[0] }},
                homeTeam: "{{ match[8] }}",
                awayTeam: "{{ match[9] }}",
                time: matchDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
        {% endfor %}
        
        // Create weeks
        for (let i = 0; i < 6; i++) {
            // Stop if we've gone beyond the last day and completed a row
            if (date > lastDay.getDate() && i > 0) break;
            
            const row = document.createElement('tr');
            
            // Create days in a week
            for (let j = 0; j < 7; j++) {
                const cell = document.createElement('td');
                cell.classList.add('calendar-cell');
                
                if (i === 0 && j < firstDayOfWeek) {
                    // Previous month days
                    const prevMonthLastDay = new Date(year, month, 0).getDate();
                    const prevDate = prevMonthLastDay - (firstDayOfWeek - j - 1);
                    
                    cell.textContent = prevDate;
                    cell.classList.add('text-muted');
                } else if (date > lastDay.getDate()) {
                    // Next month days
                    cell.textContent = nextMonthDate;
                    cell.classList.add('text-muted');
                    nextMonthDate++;
                } else {
                    // Current month days
                    cell.textContent = date;
                    
                    // Check if current date
                    const currentDateCheck = new Date();
                    if (date === currentDateCheck.getDate() && 
                        month === currentDateCheck.getMonth() && 
                        year === currentDateCheck.getFullYear()) {
                        cell.classList.add('bg-primary', 'text-white');
                    }
                    
                    // Check if date has matches
                    const dateStr = `${year}-${month}-${date}`;
                    if (matchesByDate[dateStr]) {
                        const matchesContainer = document.createElement('div');
                        matchesContainer.classList.add('mt-1');
                        
                        matchesByDate[dateStr].forEach(match => {
                            const matchElement = document.createElement('div');
                            matchElement.classList.add('calendar-match', 'small');
                            matchElement.innerHTML = `
                                <a href="/match/match_details/${match.id}" class="text-decoration-none">
                                    <span class="badge bg-warning text-dark">${match.time}</span>
                                    ${match.homeTeam} vs ${match.awayTeam}
                                </a>
                            `;
                            matchesContainer.appendChild(matchElement);
                        });
                        
                        cell.appendChild(matchesContainer);
                    }
                    
                    date++;
                }
                
                row.appendChild(cell);
            }
            
            calendarBody.appendChild(row);
        }
    }
    
    // Month navigation
    document.getElementById('prevMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendarHeader();
        renderCalendar();
    });
    
    document.getElementById('nextMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendarHeader();
        renderCalendar();
    });
</script>
{% endblock %}
{% endblock %}